name: 'PyPI Poetry Publish'
description: 'Opinionated GitHub action to fully automate publishing packages to any PyPI registry - using Poetry and GitHub releases'
branding:
  icon: 'package'
  color: 'blue'

inputs:
  ACCESS_TOKEN:
    description: 'Access Token for GitHub with write access on the repository'
    required: true
  PYTHON_VERSION:
    description: 'Python Version'
    required: false
    default: '3.10'
  PACKAGE_DIRECTORY:
    description: 'Directory of the package'
    required: false
    default: './'
  PYPI_PASSWORD:
    description: 'Password for the user to publish to PyPI. May also be a Token - requires the `PYPI_USERNAME` to be `__token__`'
    required: true
  PYPI_USERNAME:
    description: 'The username for the registry. Defaults to __token__'
    required: false
    default: '__token__'
  POETRY_VERSION:
    description: 'The version of Poetry to use'
    required: false
    default: '1.1.8'
  POETRY_CORE_VERSION:
    description: 'The version of Poetry Core to use'
    required: false
    default: '1.0.4'
  BRANCH:
    description: 'Branch to publish from'
    required: false
    default: 'master'
  ADDITIONAL_POETRY_INSTALL_STEPS:
    description: 'Allows to add additional steps to the poetry installation'
    required: false
  PUBLISH_REGISTRY:
    description: 'The registry to publish to'
    required: false
    default: 'https://pypi.org/simple/'

runs:
  using: 'composite'
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        ref: ${{ inputs.BRANCH }}
        token: ${{ inputs.ACCESS_TOKEN }}

    - name: Install poetry
      run: pip install poetry==${{ inputs.POETRY_VERSION }} poetry-core==${{ inputs.POETRY_CORE_VERSION }}
      shell: bash

    - name: Set up Python ${{ inputs.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.PYTHON_VERSION }}
        cache: 'poetry'
        check-latest: true

    - name: Set GitHub Tag as Package Version
      run: |
        echo __version__="'"${{ github.event.release.tag_name }}"'" > ${{ inputs.PACKAGE_DIRECTORY }}__init__.py
        sed -i '0,/version =.*/s//version = "'"${{ github.event.release.tag_name }}"'"/' ./pyproject.toml
      shell: bash

    - name: Add and Commit Version
      run: |
        git add ${{ inputs.PACKAGE_DIRECTORY }}__init__.py ./pyproject.toml
        git config --global user.name "PyPI Poetry Publish Bot"
        git config --global user.email "admin@code-specialist.com"
        git commit -m "Change version to ${{ github.event.release.tag_name }}" --allow-empty
        git push origin HEAD:${{ inputs.BRANCH }}
      shell: bash

    - name: Install dependencies
      if: inputs.ADDITIONAL_POETRY_INSTALL_STEPS != ''
      run: |
        declare -a commands=${{ inputs.ADDITIONAL_POETRY_INSTALL_STEPS }}
        for (( i = 0; i < ${#commands[@]} ; i++ )); do
            eval "${commands[$i]}"
        done
        poetry install --no-root
      shell: bash

    - name: Install dependencies
      if: inputs.ADDITIONAL_POETRY_INSTALL_STEPS == ''
      run: |
        poetry install --no-root
      shell: bash

    - name: Build and Publish
      run: |
        poetry config repositories.publish ${{ inputs.PUBLISH_REGISTRY }}    
        poetry publish -p ${{ inputs.PYPI_PASSWORD }} -u ${{ inputs.PYPI_USERNAME }} -r publish --build
      shell: bash
